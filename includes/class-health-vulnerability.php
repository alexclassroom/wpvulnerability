<?php
/**
 * Primary class file for the Health Check plugin.
 *
 * @package Health Check
 */

// Make sure the file is not directly accessible.
if ( ! defined( 'ABSPATH' ) ) {
	die( 'We\'re sorry, but you can not directly access this file.' );
}

/**
 * Class HealthCheck
 */
class Health_WPVulnerability {

	public function __construct() {
		add_filter( 'site_status_tests', array( $this, 'add_vulnerability_core_test' ) );
	}

	public function add_vulnerability_core_test( $tests ) {
		$tests['direct']['wpvulnerability_core'] = array(
			'label' => __( 'My Caching Test' ),
			'test'  => array( $this, 'test_vulnerability_core' ),
		);
		return $tests;
  }

	public function test_vulnerability_core() {
		$result = array(
			'label'       => __( 'There are no vulnerabilities in WordPress Core.' ),
			'status'      => 'good',
			'badge'       => array(
				'label' => __( 'Security' ),
				'color' => 'green',
			),
			'description' => sprintf(
				'<p>%s</p>',
				__( 'Caching can help load your site more quickly for visitors.' )
			),
			'actions'     => '',
			'test'        => array( $this, 'test_vulnerability_core' ),
		);
		$core_vulnerabilities = wpvulnerability_get_core();

		if ( ! empty( $core_vulnerabilities ) ) {
			$result['status'] = 'critical';
			$result['label'] = __( 'There are vulnerabilities in WordPress Core.', 'wpvulnerability' );
			$result['description'] = sprintf(
				'<p>%1$s</p> %2$s',
				__( 'We have found vulnerabilities in WordPress Core.', 'wpvulnerability' ),
				$this->get_html_vulnerabilities( $core_vulnerabilities )
			);
			$result['actions'] .= sprintf(
				'<p><a href="%s">%s</a></p>',
				esc_url( admin_url( 'update-core.php' ) ),
				__( 'Update WordPress Core' )
			);
		}

		return $result;
	}
	private function get_html_vulnerabilities( $vulnerabilities ) {
		$html = '<table>';
		foreach ( $vulnerabilities as $vulnerability ) {
			foreach ( $vulnerability['source'] as $source ) {
				$html .= '<tr>';
				$html .= '<td style="background-color:#FAEDE8;padding: 4px 15px 4px 0;"><strong>' . esc_html( $vulnerability['name'] ) . '<br/>' .  esc_html( $source['name'] ) . '<br/>' .  esc_html( $source['date'] ) . '</strong></td>';
				$html .= '<td style="background-color:#FAEDE8;padding: 4px 15px 4px 0;">' . esc_html( $source['description'] ) . '</td>';
				$html .= '</tr>';
			}
		}
		$html .= '</table>';
		return $html;
	}
}

new Health_WPVulnerability();
