<?php
/**
 * Primary class file for the Health Check plugin.
 *
 * @package Health Check
 */

// Make sure the file is not directly accessible.
if ( ! defined( 'ABSPATH' ) ) {
	die( 'We\'re sorry, but you can not directly access this file.' );
}

/**
 * Class CLI
 */
class CLI_WPVulnerability {

	/**
	 */
	public function __construct( $plugins_wpvulnnerability ) {
		// error_log( print_r( $plugins_wpvulnnerability->get_installed_plugins(), true ) );

		$this->plugins = $plugins_wpvulnnerability->get_installed_plugins();

		if ( class_exists( 'WP_CLI' ) ) {
			WP_CLI::add_command( 'wpvulnerability', array( $this, 'sample_command' ) );
		}
	}

	/**
	 */
	public function sample_command() {
		$result = '';
		foreach ( $this->plugins as $plugin ) {
			if ( 'true' === $plugin['vulnerable'] ) {
				$name = $plugin['Name'];
				WP_CLI::line( WP_CLI::colorize( "%r$name:%n " ) );
				$vulnerabilities = array();
				foreach ( $plugin['vulnerabilities'] as $vulnerability ) {
					$sources =  '';
					foreach ( $vulnerability['source'] as $source ) {
						error_log( print_r( $source, true ) );
						$sources .= $source['link'] . "\n";
					}

					array_push(
						$vulnerabilities,
						array(
							'name'     => $vulnerability['name'],
							'versions' => $vulnerability['versions'],
							'source'   => $sources,
						)
					);
				}

				WP_CLI\Utils\format_items(
					'table',
					$vulnerabilities,
					array( 'name', 'versions', 'source' )
				);

			}
		}
	}
}
