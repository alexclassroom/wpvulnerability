<?php
/**
 * Themes functions
 *
 * @package WPVulnerability
 * @version 2.0.0
 */
defined( 'ABSPATH' ) || die( 'No script kiddies please!' );


/**
 * After Row Text
 * callback function for adding vulnerability notice under vulnerable themes
 *
 * @param  string $theme_file main theme folder/file_name.
 * @param  array  $theme_data theme data.
 * @param  array  $status Status.
 * @return void
 */

function wpvulnerability_theme_info_after( $theme_file, $theme_data, $status ) {

	$theme_vulnerabilities = json_decode( get_option( 'wpvulnerability-themes' ), true );
	
	/*
	echo '<pre>';
	print_r($theme_vulnerabilities);
	echo '</pre>';
	exit;
	*/

	$tr_class = '';
	if ( is_theme_active( $theme_file ) ) {
		$tr_class .= 'active';
	}

	$message = sprintf(
		/* translators: 1: theme name */
		__( '%1$s has a known vulnerability that may be affecting this version.', 'wpvulnerability' ),
		wp_kses( $theme_data['Name'], 'strip' )
	);

	$information  = '<tr class="wpvulnerability ' . $tr_class . '">';
	$information .= '<td colspan="4">';
	$information .= '<p class="text-red"><img src="' . esc_url( WPVULNERABILITY_PLUGIN_URL ) . 'assets/logo16.png" style="height: 16px; vertical-align: text-top; width: 16px;" alt="" title="WPVulnerability"> <strong>' . $message . '</strong>';
	$information .= '</p>';
	$information .= '<table>';

	$vulnerabilities = $theme_vulnerabilities[ $theme_file ]['vulnerabilities'];

	/*
	echo '<pre>';
	print_r($vulnerabilities);
	echo '</pre>';
	exit;
	*/

	foreach ( $vulnerabilities as $vulnerability ) {

		$what = array();
		if( isset( $vulnerability['impact']['cwe'] ) ) {
			foreach( $vulnerability['impact']['cwe'] as $vulnerability_cwe ) {
				$what[] = '<div><b>' . wp_kses( $vulnerability_cwe['name'], 'strip' ) . '</b></div><div><i>' . wp_kses_post( $vulnerability_cwe['description'] ) . '</i></div>';
			}
		}

		$sources = array();
		if( isset( $vulnerability['source'] ) ) {
			foreach( $vulnerability['source'] as $vulnerability_source ) {
				$sources[] = '<a href="' . sanitize_url( $vulnerability_source['link'], 'strip') . '" target="_blank" rel="external nofollow noopener noreferrer">[+]</a>&nbsp;' . wp_kses( $vulnerability_source['name'], 'strip' );
			}
		}
		if( count( $sources ) ) {
			$source = '<div style="padding-bottom: 5px;">' . implode( '<br>', $sources ) . '</div>';
		}

		$score = null;
		if( isset( $vulnerability['impact']['cvss']['score'] ) ) {
			$score = number_format( (float) $vulnerability['impact']['cvss']['score'], 1, '.', '' );
		}
		$severity = null;
		if( isset( $vulnerability['impact']['cvss']['severity'] ) ) {
			$severity = wpvulnerability_severity( $vulnerability['impact']['cvss']['severity'] );
		}
		$exploitable = null;
		if( isset( $vulnerability['impact']['cvss']['exploitable'] ) ) {
			$exploitable = number_format( (float) $vulnerability['impact']['cvss']['exploitable'], 1, '.', '' );
		}

		$information .= '<tr>';
		$information .= '<td style="max-width: 256px; min-width: 96px;"><b>' . wp_kses( $vulnerability['versions'], 'strip' ) . '</b></td>';
		$information .= '<td>';
		if( (int)$vulnerability['closed'] || (int)$vulnerability['unfixed'] ) {
			$information .= '<div style="padding-bottom: 5px;">';
			if( (int)$vulnerability['closed'] ) {
				$information .= '<div class="text-red">' . __( 'This theme is closed. Please replace it with another.', 'wpvulnerability' ) . '</div>';
			}
			if( (int)$vulnerability['unfixed'] ) {
				$information .= '<div class="text-red">' . __( 'This vulnerability appears to be unpatched. Stay tuned for upcoming theme updates.', 'wpvulnerability' ) . '</div>';
			}
			$information .= '</div>';
		}
		if( count( $what ) ) {
			$information .= '<div style="padding-bottom: 5px;">';
			foreach( $what as $w ) {
				$information .= $w;
			}
			$information .= '</div>';
		}
		if( !is_null( $score ) || !is_null( $severity ) || !is_null( $exploitable ) ) {
			$information .= '<div style="padding-bottom: 5px;">';
			if( !is_null( $score ) ) {
				$information .= '<div>' . __( 'Global score: ', 'wpvulnerability' ) . $score . ' / 10</div>';
			}
			if( !is_null( $severity ) ) {
				$information .= '<div>' . __( 'Severity: ', 'wpvulnerability' ) . $severity . '</div>';
			}
			if( !is_null( $exploitable ) ) {
				$information .= '<div>' . __( 'Exploitability: ', 'wpvulnerability' ) . $exploitable . ' / 10</div>';
			}
			$information .= '</div>';
		}
		$information .= wp_kses( $source, 'post' );
		$information .= '</td>';
		$information .= '</tr>';

	}

	$information .= '</table>';
	$information .= '</td>';
	$information .= '</tr>';

	echo $information; // phpcs:ignore
}

/**
 * Get Fresh theme Vulnerabilities
 * pull vulnerabilities through API, compare version to vulnerabilities, add is_know_vulnerable key
 *
 * @param  array  $theme_data theme data.
 * @param  string $file_path theme file path.
 * @return array  updated theme
 */
function get_fresh_theme_vulnerabilities( $theme_data, $theme_slug ) {

	$theme_version = wp_kses( $theme_data['data']->get( 'Version' ), 'strip' );

	$theme_data_v['slug'] = $theme_slug;
	$theme_data_v['vulnerabilities'] = null;
	$theme_data_v['vulnerable'] = 0;

	if( $theme_slug ) {

		$theme_api_response = wpvulnerability_get_theme( $theme_slug, $theme_version );

		if ( !empty( $theme_api_response ) ) {

			$theme_data_v['vulnerabilities'] = $theme_api_response;
			$theme_data_v['vulnerable'] = 1;

		}

	}

	return $theme_data_v;
}



/**
 * Get Installed themes
 * gets the installed themes, checks for vulnerabilities in them, caches the data, sends email if vulnerabilities detected
 *
 * @return array
 */

function wpvulnerability_theme_get_installed() {

	$themes_v = array();
	$themes = wp_get_themes();

	foreach ( $themes as $slug => $theme_data ) {

		$themes_v[$slug]['data'] = $theme_data;
		$themes_v[$slug]['wpvulnerability'] = get_fresh_theme_vulnerabilities( $themes_v[$slug], $slug );

	}

	update_option( 'wpvulnerability-themes', wp_json_encode( $themes_v ) );

	return wp_json_encode( $themes_v );
}


/**
 * Get Installed themes cache
 *
 * @return array
 */
 
function wpvulnerability_theme_get_vulnerabilities( ) {

	$theme_data_cache = json_decode( get_option( 'wpvulnerability-themes-cache' ) );
	$theme_data = json_decode( get_option( 'wpvulnerability-themes' ), true );

	if( $theme_data_cache < time() || empty( $theme_data ) ) {

		$theme_data = json_decode( wpvulnerability_theme_get_installed( ), true );
		update_option( 'wpvulnerability-themes-cache', wp_json_encode( number_format( time() + ( 3600 * WPVULNERABILITY_CACHE_HOURS ), 0, '.', '' ) ) );

	}

	return $theme_data;

}

/**
 * Get Installed themes cache
 *
 * @return array
 */
function wpvulnerability_theme_get_vulnerabilities_clean( ) {

	wpvulnerability_theme_get_installed( );

}


/**
 * Admin Head
 * gets installed themes cache, adds after row text and notices based on the results for the theme page
 *
 * @return void
 */
/*
function wpvulnerability_theme_page() {
	global $pagenow;
	if( 'themes.php' == $pagenow ) {

		$themes = wpvulnerability_theme_get_vulnerabilities();

		foreach ( $themes as $theme_data ) {

			if ( isset( $theme_data['wpvulnerability']['vulnerable'] ) && 1 === $theme_data['wpvulnerability']['vulnerable'] ) {

				//add_action( 'after_theme_row_' . $theme_data['wpvulnerability']['slug'], 'wpvulnerability_theme_info_after', 10, 3 );
				//add_action( 'admin_print_scripts-themes.php', 'wpvulnerability_theme_info_theme_js' );

				//add_filter( 'wp_prepare_themes_for_js', array( self::$instance, 'wpr_prepare_themes_js' ) );

				if ( isset( $_GET['theme'] ) && $_GET['theme'] == $theme_data['wpvulnerability']['slug'] ) {
?>
		<script>

var wpvulnerability_vars;
jQuery.noConflict();

(function( $ ) {

	jQuery.fn.contentChange = function( callback ) {
		var elms = jQuery( this );
		elms.each(
			function( i ) {
				var elm = jQuery( this );
				elm.data( 'lastContents', elm.html() );
				window.watchContentChange = window.watchContentChange ? window.watchContentChange : [];
				window.watchContentChange.push( { 'element': elm, 'callback': callback } );
			}
		);
		return elms;
	};
	setInterval( function() {
		if ( window.watchContentChange ) {
			for ( i in window.watchContentChange ) {
				if ( window.watchContentChange[ i ].element.data( 'lastContents' ) !== window.watchContentChange[ i ].element.html() ) {
					window.watchContentChange[ i ].callback.apply( window.watchContentChange[ i ].element );
					window.watchContentChange[ i ].element.data( 'lastContents', window.watchContentChange[ i ].element.html() );
				}

			}
		}
	}, 150 );

	// On DOM Ready
	$( function() {
		var themes;

		themes = wp.themes = wp.themes || {};
		themes.data = typeof _wpThemeSettings !== 'undefined' ? _wpThemeSettings : '';

		// Is only one theme active?
		if( themes.data.themes.length === 1 ) {
			// Show the rollback button.
			
			// SHOW THE INFORMATION
			wpvulnerability_theme_rollback(themes.data.themes[0].id);
			
			
			
		}

		// On clicking a theme template
		$( '.theme-overlay' ).contentChange( function( e ) {

			// get theme name that was clicked
			var clicked_theme = wpvulnerability_get_parameter_by_name( 'theme' );

			// check that rollback button hasn't been placed
			if ( wpvulnerability_is_rollback_btn_there() ) {
				// button is there, bail
				return false;
			}

			// pass off to rollback function
			wpvulnerability_theme_rollback( clicked_theme );

		} );

		function wpvulnerability_is_rollback_btn_there() {

			if ( $( '.wpvulnerability-theme-info' ).length > 0 ) {
				return true;
			}
			return false;

		}

		function wpvulnerability_theme_rollback( theme ) {

			var theme_data = wpvulnerability_get_theme_data( theme );

			// ensure this theme can be rolled back (not premium, etc)
			if ( theme_data !== null ) {

				var active_theme = $( '.theme-overlay' ).hasClass( 'active' );

				var wpvulnerability_btn_html = 'HOLA';

				$( '.theme-wrap' ).find( '.theme-actions' ).append( wpvulnerability_btn_html );

			} else {
				// Can't roll back this theme, display the notice.
				$( '.theme-wrap' ).find( '.theme-actions' ).append( '<span class="no-rollback" style="position: absolute;left: 23px;bottom: 16px;font-size: 12px;font-style: italic;color: rgb(181, 181, 181);">wpvulnerability NOT AVAILABLE</span>' );
			}

		}

		function wpvulnerability_get_theme_data( theme ) {

			var theme_data = wp.themes.data.themes;

			// Loop through complete theme data to find this current theme's data
			for ( var i = 0, len = theme_data.length; i < len; i ++ ) {
				if ( theme_data[ i ].id === theme ) {
					return theme_data[ i ]; // Return as soon as the object is found
				}
			}
			return null; // The object was not found
		}

		function wpvulnerability_get_parameter_by_name( name ) {
			name = name.replace( /[\[]/, '\\[' ).replace( /[\]]/, '\\]' );
			var regex = new RegExp( '[\\?&]' + name + '=([^&#]*)' ),
				results = regex.exec( location.search );
			return results === null ? '' : decodeURIComponent( results[ 1 ].replace( /\+/g, ' ' ) );
		}

		function wpr_get_parameter_from_focused_theme() {
			var focused_theme = wp.themes.focusedTheme;
			var name = $( focused_theme ).find( '.theme-name' ).attr( 'id' );

			if ( typeof name !== 'undefined' ) {
				name = name.replace( '-name', '' );
			} else {
				return false;
			}

			return name;
		}

	} );

})( jQuery );

		</script>




<?php
				}

			}

		}

	}
}
add_action( 'admin_head', 'wpvulnerability_theme_page' );
*/

add_action( 'upgrader_process_complete', 'wpvulnerability_theme_get_vulnerabilities_clean' , 10, 2 );
