<?php
/**
 * WPVulnerability REST API Endpoints
 *
 * @package WPVulnerability
 *
 * @since 3.3.0
 */

/**
 * Handle the core vulnerabilities REST API request.
 *
 * @since 3.3.0
 *
 * @return WP_REST_Response Core vulnerabilities data.
 */
function wpvulnerability_rest_core_vulnerabilities() {

	require_once WPVULNERABILITY_PLUGIN_PATH . '/wpvulnerability-core.php';

	$core_vulnerabilities = wpvulnerability_core_get_vulnerabilities();

	if ( empty( $core_vulnerabilities ) ) {
		return new WP_REST_Response( array( 'message' => 'No vulnerabilities found.' ), 404 );
	}

	return new WP_REST_Response( $core_vulnerabilities, 200 );
}

/**
 * Handle the plugins vulnerabilities REST API request.
 *
 * @since 3.3.0
 *
 * @return WP_REST_Response Plugins vulnerabilities data.
 */
function wpvulnerability_rest_plugins_vulnerabilities() {

	require_once WPVULNERABILITY_PLUGIN_PATH . '/wpvulnerability-plugins.php';

	$plugins_vulnerabilities = wpvulnerability_plugin_get_vulnerabilities();

	if ( empty( $plugins_vulnerabilities ) ) {
		return new WP_REST_Response( array( 'message' => 'No vulnerabilities found.' ), 404 );
	}

	return new WP_REST_Response( $plugins_vulnerabilities, 200 );
}

/**
 * Handle the themes vulnerabilities REST API request.
 *
 * @since 3.3.0
 *
 * @return WP_REST_Response Themes vulnerabilities data.
 */
function wpvulnerability_rest_themes_vulnerabilities() {

	require_once WPVULNERABILITY_PLUGIN_PATH . '/wpvulnerability-themes.php';

	$themes_vulnerabilities = wpvulnerability_theme_get_vulnerabilities();

	if ( empty( $themes_vulnerabilities ) ) {
		return new WP_REST_Response( array( 'message' => 'No vulnerabilities found.' ), 404 );
	}

	return new WP_REST_Response( $themes_vulnerabilities, 200 );
}

/**
 * Handle the PHP vulnerabilities REST API request.
 *
 * @since 3.3.0
 *
 * @return WP_REST_Response PHP vulnerabilities data.
 */
function wpvulnerability_rest_php_vulnerabilities() {

	require_once WPVULNERABILITY_PLUGIN_PATH . '/wpvulnerability-php.php';

	$php_vulnerabilities = wpvulnerability_php_get_vulnerabilities();

	if ( empty( $php_vulnerabilities ) ) {
		return new WP_REST_Response( array( 'message' => 'No vulnerabilities found.' ), 404 );
	}

	return new WP_REST_Response( $php_vulnerabilities, 200 );
}

/**
 * Handle the Apache vulnerabilities REST API request.
 *
 * @since 3.3.0
 *
 * @return WP_REST_Response Apache vulnerabilities data.
 */
function wpvulnerability_rest_apache_vulnerabilities() {

	require_once WPVULNERABILITY_PLUGIN_PATH . '/wpvulnerability-apache.php';

	$apache_vulnerabilities = wpvulnerability_apache_get_vulnerabilities();

	if ( empty( $apache_vulnerabilities ) ) {
		return new WP_REST_Response( array( 'message' => 'No vulnerabilities found.' ), 404 );
	}

	return new WP_REST_Response( $apache_vulnerabilities, 200 );
}

/**
 * Handle the nginx vulnerabilities REST API request.
 *
 * @since 3.3.0
 *
 * @return WP_REST_Response nginx vulnerabilities data.
 */
function wpvulnerability_rest_nginx_vulnerabilities() {

	require_once WPVULNERABILITY_PLUGIN_PATH . '/wpvulnerability-nginx.php';

	$nginx_vulnerabilities = wpvulnerability_nginx_get_vulnerabilities();

	if ( empty( $nginx_vulnerabilities ) ) {
		return new WP_REST_Response( array( 'message' => 'No vulnerabilities found.' ), 404 );
	}

	return new WP_REST_Response( $nginx_vulnerabilities, 200 );
}

/**
 * Custom permission check for the WPVulnerability REST API.
 *
 * @since 3.3.0
 *
 * @param WP_REST_Request $request The REST API request.
 *
 * @return bool True if the user has permission, false otherwise.
 */
function wpvulnerability_permission_check( WP_REST_Request $request ) {

	// Check if the request is authenticated using an Application Password
	if ( wp_is_application_passwords_available() ) {
		$authorization_header = $request->get_header( 'authorization' );
		if ( $authorization_header && preg_match( '/^Basic\s(.+)$/i', $authorization_header, $matches ) ) {
			$auth_string             = base64_decode( $matches[1] );
			list( $user, $password ) = explode( ':', $auth_string );

			if ( wp_authenticate_application_password( null, $user, $password ) instanceof WP_User ) {
				return true;
			}
		}
	}

	return false;
}

/**
 * Register REST API routes.
 *
 * @since 3.3.0
 *
 * @return void
 */
function wpvulnerability_register_rest_routes() {

	$endpoints = array(
		'core',
		'plugins',
		'themes',
		'php',
		'apache',
		'nginx',
	);

	foreach ( $endpoints as $endpoint ) {
		register_rest_route(
			'wpvulnerability/v1',
			'/' . $endpoint,
			array(
				'methods'             => 'GET',
				'callback'            => 'wpvulnerability_rest_' . $endpoint . '_vulnerabilities',
				'permission_callback' => 'wpvulnerability_permission_check',
			)
		);
	}
}


// Hook to initialize REST API endpoints.
add_action( 'rest_api_init', 'wpvulnerability_register_rest_routes' );
